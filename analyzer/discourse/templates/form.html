{% load static %}
{% load form_extras %}
<!doctype html>
<html lang="kk">
  <head>
    <meta charset="utf-8"></meta>
    <title>Саяси мәтін анализаторы</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <h1 class="mb-3">Саяси мәтіннің эмоциялық/сентимент талдауы</h1>

      <form method="post" class="card shadow-sm p-3 mb-3">
        {% csrf_token %}
        <div class="mb-3">
          <label class="form-label">{{ form.text.label }}</label>
          {{ form.text|add_class:"form-control" }}
        </div>

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">{{ form.domain.label }}</label>
            {{ form.domain|add_class:"form-select" }}
          </div>
          <div class="col-md-4">
            <label class="form-label">{{ form.source.label }}</label>
            {{ form.source|add_class:"form-select" }}
          </div>
          <div class="col-md-4">
            <label class="form-label">{{ form.task.label }}</label>
            {{ form.task|add_class:"form-select" }}
          </div>
        </div>

        <div class="mt-3">
          <button class="btn btn-primary">Талдау</button>
        </div>
      </form>

      {% if error %}
        <div class="alert alert-warning">
          {{ error }}<br>
          <small class="text-muted">Ескерту: transformers/torch орнатылмаған болуы мүмкін.</small>
        </div>
      {% endif %}

{% if result %}
  <div class="card shadow-sm p-3">
    <h5 class="mb-2">Нәтиже</h5>
    
    <p class="mb-1">
      <span class="badge text-bg-primary">{{ result.label }}</span>
      <span class="text-muted">({{ result.score|floatformat:2 }})</span>
    </p>

    {% if result.alternatives %}
      <div class="text-muted">Балама болжамдар:
        {% for alt in result.alternatives %}
          <span class="badge text-bg-secondary me-1">{{ alt.label }} {{ alt.score|floatformat:2 }}</span>
        {% endfor %}
      </div>
    {% endif %}
{% if result.political.available %}
  <p>Саяси дискурс: {{ result.political.is_political|yesno:"Иә,Жоқ,Белгісіз" }}</p>
{% endif %}
    {% if result.warning %}
      <div class="alert alert-warning mt-3">{{ result.warning }}</div>
    {% endif %}
  
{% endif %}
{% if result.tactic_zero_shot %}
  <p><strong>Саяси дискурс тактикасы:</strong><br>
    {% if result.tactic_zero_shot.label %}<span class="badge text-bg-primary">{{ result.tactic_zero_shot.label }}</span> ({{ result.tactic_zero_shot.score|floatformat:2 }})
    {% else %}—
    {% endif %}
  </p>
  {% if result.tactic_zero_shot.alternatives %}
    <ul>
      {% for alt in result.tactic_zero_shot.alternatives %}
        <li>{{ alt.label }} — {{ alt.score|floatformat:2 }}</li>
      {% endfor %}
    </ul>
  {% endif %}
  {% if result.tactic_zero_shot.warning %}
    <p class="text-warning">{{ result.tactic_zero_shot.warning }}</p>
  {% endif %}
{% endif %}
{% if result.campaign %}
  <div class="card">
    <h3>Сайлауалды жарнама — домендік талдау</h3>
    <p><b>Әдістер саны:</b>
      {{result.campaign.devices}}
      {% for k,v in result.campaign.devices.items %}
        <span class="badge">{{k}}: {{v}}</span>
      {% empty %} Жоқ {% endfor %}
    </p>
    {% if result.campaign.onto_prior %}
      <p><b>Онтология приоры:</b> {{ result.campaign.onto_prior }}</p>
    {% endif %}
    <p><b>Ережелік болжам:</b> {{ result.campaign.rule_pred.sentiment }} / {{ result.campaign.rule_pred.emotion }}</p>
    <p><b>Қорытынды (финал):</b> {{ result.campaign.fused.label }} ({{ result.campaign.fused.score|floatformat:2 }})</p>

    <details>
      <summary>Онтологиядан табылғандар</summary>
      <ul>
        {% for h in result.campaign.hits.ontology %}
          <li>
            “{{ h.match }}”
            {% if h.onto_devices and h.onto_polarity %}
              — device: {{ h.onto_devices|join:", " }}, polarity: {{ h.onto_polarity }}
            {% endif %}
            {% if h.labels %}
              <br/><small>labels: {{ h.labels|join:", " }}</small>
            {% endif %}
            {% if h.inst %}
              <br/><small>IRI: {{ h.inst }}</small>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </details>

    <details>
      <summary>Regex матчтары</summary>
      <ul>
        {% for h in result.campaign.hits.regex %}
          <li>[{{ h.device }}] “{{ h.match }}” <small>({{ h.span.0 }}–{{ h.span.1 }})</small></li>
        {% endfor %}
      </ul>
    </details>
  </div>
{% endif %}
{% if result.speech %}
  <div class="card">
    <h3>Үміткер/саяси қайраткер сөзі</h3>
    <p><b>Нысана бойынша қорытынды баға:</b></p>
    <ul>
      {% for s in result.speech.stance %}
        <li>{{ s.kind }} → {{ s.iri }} : {{ s.label }} 
          <small>(+{{ s.votes.pos }}/-{{ s.votes.neg }})</small>
        </li>
      {% endfor %}
    </ul>
    <details>
      <summary>Сөйлемдік талдау</summary>
      <ol>
        {% for it in result.speech.items %}
          <li>«{{ it.text }}» — {{ it.sentiment }} ({{ it.score|floatformat:2 }})
            {% if it.targets and it.targets|length > 0 %}
              <br/><small>Нысаналар: 
                {% for t in it.targets %}
                  [{{ t.kind }}] {{ t.match }}
                {% endfor %}
              </small>
            {% endif %}
          </li>
        {% endfor %}
      </ol>
    </details>
  </div>
{% endif %}
{% if result.debate %}
  <div class="card">
    <h3>Сайлауалды пікірсайыс</h3>
    <p><b>Спикерлер бойынша жиынтық:</b></p>
    <ul>
      {% for sp, cnt in result.debate.by_speaker.items %}
        <li>{{ sp }} — +{{ cnt.оң }} / -{{ cnt.теріс }} / {{ cnt.бейтарап }}</li>
      {% endfor %}
    </ul>
    <details>
      <summary>Репликалар</summary>
      <ol>
        {% for t in result.debate.turns %}
          <li><b>{{ t.speaker }}</b>: «{{ t.text }}» — {{ t.sentiment }} ({{ t.score|floatformat:2 }})
            {% if t.flags.attack %}<span class="badge">шабуыл</span>{% endif %}
            {% if t.flags.question %}<span class="badge">сұрақ</span>{% endif %}
            {% if t.flags.defend %}<span class="badge">қорғану</span>{% endif %}
            {% if t.flags.concede %}<span class="badge">жартылай келісу</span>{% endif %}
          </li>
        {% endfor %}
      </ol>
    </details>
  </div>
{% endif %}

    </div>
  </body>
</html>